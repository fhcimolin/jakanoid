<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height initial-scale=1">
    </head>
    <body>
        <canvas id="myCanvas" width="576" height="500" style="border: solid black 1px">
        </canvas>

        <script>
            var WAITING_TIME_LOST_LIFE = 2000;
            var POINTS_PER_BRICK = 10;
            var MAX_LIVES = 3;
            
            var GAME_STAND_BY = 0;
            var GAME_RUNNING = 1;
            var GAME_AWAIT = 2;
            var GAME_OVER = 3;
            var GAME_WIN = 4;

            var gameState = GAME_STAND_BY;
            var lives = MAX_LIVES;
            var score = 0;

            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");

            var ballX = canvas.width / 2;
            var ballY = canvas.height / 2;

            var ballAngle = 75;
            var ballSpeed = 1;

            var brickWidth = 32;
            var brickHeight = 16;
            
            var paddleWidth = 70;
            var paddleX = (canvas.width / 2) - (paddleWidth / 2);
            var paddleY = canvas.height - 60;

            var BRICK_MODEL = [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]
            ];

            var brickArray = BRICK_MODEL.slice();

            function drawBricks(){
                var bricks = brickArray;

                for(var i = 0; i < bricks.length; i++) {
                    var brick = bricks[i];
                    for(var j = 0; j < brick.length; j++) {
                        if(bricks[i][j] > 0){
                            drawBrick(j*brickWidth,i*brickHeight);
                        }
                    }
                }
            }

            function areAllBricksWiped(){
                var bricks = brickArray;

                var sum = 0;

                for(var i = 0; i < bricks.length; i++) {
                    var brick = bricks[i];
                    for(var j = 0; j < brick.length; j++) {
                        if(bricks[i][j] > 0){
                            sum++;
                        }
                    }
                }

                return sum == 0;
            }

            function resetAllBricks(){
                brickArray = BRICK_MODEL;
            }

            function drawBrick(x,y){
                context.fillStyle = "rgba(100,100,100,1)";
                context.fillRect(x,y,brickWidth,brickHeight);
                context.strokeStyle = "rgba(255,255,255,1)";
                context.strokeRect(x,y,brickWidth,brickHeight);
            }

            function drawBall(){
                context.strokeStyle = "rgba(0,0,0,1)";
                context.beginPath();
                context.arc(ballX, ballY, 3, 0, 2 * Math.PI);
                context.stroke();
            }

            function toRadians (angle) {
                return angle * (Math.PI / 180);
            }

            function driftBall(){
                var angle = toRadians(ballAngle);
                
                ballX += ballSpeed * Math.cos(angle);
                ballY += ballSpeed * -Math.sin(angle);
            }

            function driftBallBackwards(){
                var angle = toRadians(ballAngle);
                
                ballX -= ballSpeed * Math.cos(angle);
                ballY -= ballSpeed * -Math.sin(angle);
            }

            function ballOutOfXBounds(){
                return ballX > canvas.width || 
                       ballX < 0;
            }

            function ballOutOfYBounds(){
                return ballY > canvas.height ||
                       ballY < 0;
            }

            function checkBallColision(){
                checkIfBallOutOfBounds();
                checkIfBallInsideBrick();
                checkIfBallInsidePaddle();
            }
            
            function checkIfBallInsidePaddle(){
                var hasBallReachedPaddleVertically = ballY > paddleY && ballY < paddleY + 10;
                var hasBallReachedPaddleFromLeft = ballX > (paddleX - (paddleWidth / 2));
                var hasBallReachedPaddleFromRight = ballX < (paddleX + paddleWidth - (paddleWidth / 2));
                
                if(hasBallReachedPaddleVertically && (hasBallReachedPaddleFromLeft && hasBallReachedPaddleFromRight)){
                    var angleRatio = (ballX - (paddleX - (paddleWidth / 2))) / paddleWidth;

                    ballAngle = 165 - (140 * angleRatio);
                }
            }

            function loseLife(){
                if(isGameRunning()){
                    ballY = canvas.height + 10; //hide ball from view
                    lives--;

                    if(lives > 0){
                        gameState = GAME_AWAIT;
                    }
                    else{
                        gameState = GAME_OVER;
                    }
                }
            }

            function checkIfBallOutOfBounds(){
                if(ballY > canvas.height){
                    loseLife();
                    return;
                }
                if(ballOutOfXBounds()){
                    ballAngle = 180 - ballAngle;
                }
                if(ballOutOfYBounds()){
                    ballAngle = 360 - ballAngle;
                }
    
                ballAngle %= 360;
            }

            function checkBallColisionAngleWithBrick(x,y){
                var collisionThreshold = 1;
                
                var ballHitBrickOnY = ballY > (y * brickHeight) + brickHeight - collisionThreshold ||
                                      ballY < (y * brickHeight) + collisionThreshold;
                var ballHitBrickOnX = ballX > (x * brickWidth) + brickWidth - collisionThreshold ||
                                      ballX < (x * brickWidth) + collisionThreshold;

                driftBallBackwards();

                if(ballHitBrickOnX){
                    ballAngle = 180 - ballAngle;
                }
                
                if(ballHitBrickOnY){
                    ballAngle = 360 - ballAngle;
                }

                ballAngle %= 360;
            }

            function checkIfBallInsideBrick(){
                var ballQuadrantX = (ballX - (ballX % brickWidth)) / brickWidth;
                var ballQuadrantY = (ballY - (ballY % brickHeight)) / brickHeight;

                if(ballQuadrantY >= brickArray.length){
                    return;
                }

                if(ballQuadrantX >= brickArray[0].length){
                    return;
                }

                if(brickArray[ballQuadrantY][ballQuadrantX] > 0){
                    brickArray[ballQuadrantY][ballQuadrantX] = 0;

                    score += POINTS_PER_BRICK;

                    checkBallColisionAngleWithBrick(
                        ballQuadrantX, 
                        ballQuadrantY);
                }
            }

            function moveBall(){
                driftBall();
                checkBallColision();
            }

            function clearScreen(){
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            function drawPaddle(){
                context.fillStyle = "rgba(100,100,100,1)";
                context.fillRect(paddleX - (paddleWidth / 2), paddleY, paddleWidth, 10);
            }

            function drawLives(){
                var livesText = "";
                
                for(var i = 0; i < lives; i++){
                    livesText += String.fromCharCode(10134); //heavy minus sign (paddle)
                }
                
                context.fillStyle = "rgba(100,100,100,1)";
                context.textAlign = "right";
                context.font = "bold 16px Arial";
                context.fillText(livesText, canvas.width - 20, 20);
            }

            function drawScore(){
                context.fillStyle = "rgba(100,100,100,1)";
                context.textAlign = "left";
                context.font = "bold 16px Arial";
                context.fillText(score, 20, 20);
            }

            function drawMessage(message){
                context.fillStyle = "rgba(100,100,100,1)";
                context.textAlign = "left";
                context.font = "bold 20px Arial";
                context.fillText(message, canvas.width / 2 - 40, canvas.height / 2);
            }

            function isGameOnStandBy(){
                return gameState == GAME_STAND_BY;
            }

            function isGameRunning(){
                return gameState == GAME_RUNNING;
            }

            function isGameOnAwait(){
                return gameState == GAME_AWAIT;
            }

            function isGameOver(){
                return gameState == GAME_OVER;
            }

            function isGameWin(){
                return gameState == GAME_WIN;
            }

            function placeBallAbovePaddle(){
                ballX = paddleX;
                ballY = paddleY - 20;
                ballAngle = 80;
            }

            function mainLoop()
            {
                clearScreen();
                
                drawBricks();
                drawBall();
                drawPaddle();
                drawLives();
                drawScore();
                
                if(isGameOnStandBy()){
                    placeBallAbovePaddle();
                }

                if(isGameRunning()){
                    moveBall();
                }

                if(isGameOnAwait()){
                    setTimeout(function(){
                        gameState = GAME_STAND_BY;
                    }, WAITING_TIME_LOST_LIFE);
                }

                if(isGameOver()){
                    drawMessage("GAME OVER");
                }

                if(isGameWin()){
                    drawGameWin("YOU DID IT!");
                    ballX = canvas.width + 10; //hide ball from view again
                }

                if(areAllBricksWiped()){
                    gameState = GAME_WIN;
                }
            }

            window.onload = function(){
                setInterval(mainLoop, 1);
            }

            function handleGameFlow(){
                if(isGameOnStandBy()){
                    gameState = GAME_RUNNING;
                }

                if(isGameOver()){
                    score = 0;
                    lives = MAX_LIVES;
                    gameState = GAME_STAND_BY;

                    resetAllBricks();
                }
            }

            canvas.onmousemove = function(event){
                paddleX = event.x;
            }

            canvas.onmousedown = function(event){
                handleGameFlow();
            }

            canvas.ontouchstart = function(event) {
                handleGameFlow();

                event.preventDefault();
            }

            canvas.ontouchmove = function(event) {
                var touch = event.targetTouches[0];
                
                paddleX = touch.pageX;
                
                event.preventDefault();
            }

        </script>
    </body>
</html>